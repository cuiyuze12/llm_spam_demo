<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>AIãƒãƒ«ãƒæ©Ÿèƒ½ãƒ‡ãƒ¢</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 40px;
      background-color: #f9f9f9;
    }
    h2 {
      color: #333;
      text-align: center;
    }
    .tab {
      display: inline-block;
      padding: 10px 20px;
      margin-right: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      cursor: pointer;
      background-color: #eee;
    }
    .tab.active {
      background-color: #007BFF;
      color: white;
    }
    .content {
      display: none;
      margin-top: 30px;
      padding: 20px;
      background-color: white;
      border: 1px solid #ddd;
      border-radius: 8px;
    }
    .content.active {
      display: block;
    }
    /* ç»Ÿä¸€è¡¨å•æ§ä»¶æ ·å¼ */
    input[type="text"],
    textarea,
    select {
      width: 80%;           /* æˆ–è€… 100%ï¼Œçœ‹ä½ æƒ³è¦çš„å®½åº¦ */
      max-width: 100%;
      padding: 10px;
      margin: 10px 0;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }
    button {
      padding: 10px 20px;
      background-color: #28a745;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background-color: #218838;
    }
    .output {
      margin-top: 20px;
      padding: 10px;
      background-color: #f1f1f1;
      border-left: 4px solid #007BFF;
      white-space: pre-wrap; 
      word-break: break-word;
    }
    .output pre {
      margin: 0; padding: 12px; background: #0b1020; color: #e6edf3; overflow-x: auto; border-radius: 6px;
    }
    .row { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
    .muted { color: #666; font-size: 12px; }
    .btn-secondary { background-color: #6c757d; }
    .btn-secondary:hover { background-color: #5c636a; }

    details summary {
      list-style: none;
      cursor: pointer;
      padding: 8px 12px;
      font-weight: bold;
      font-size: 14px;
      background-color: transparent;
      border-radius: 4px;
      transition: background-color 0.2s;
      display: inline-flex; /* â† ã“ã“é‡è¦ */
      align-items: center;
    }

    details summary:hover {
      background-color: #f0f0f0;
    }

    details[open] summary::after {
      content: "â–²";
      margin-left: 8px;  /* â† ã“ã“å¤‰æ›´ */
      color: #444;
    }

    details:not([open]) summary::after {
      content: "â–¼";
      margin-left: 8px;  /* â† ã“ã“å¤‰æ›´ */
      color: #444;
    }

    details ul {
      margin-top: 8px;
      padding-left: 20px;
      font-size: 14px;
    }

    .btn[disabled] { opacity: 0.6; cursor: not-allowed; }
  </style>
</head>
<body>
<h2>AIãƒãƒ«ãƒæ©Ÿèƒ½ãƒ‡ãƒ¢</h2>

<section style="max-width: 900px; margin: 0 auto 30px auto; padding: 10px 20px; background-color: #fff; border-left: 4px solid #007BFF;">
  <p>ã“ã®ãƒ‡ãƒ¢ã‚’ã”è¦§é ‚ãã€èª ã«ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚</p>
  <p>æœ¬ãƒ‡ãƒ¢ã§ã¯ã€è‡ªä½œã®è»½é‡LLMã€RAGã€AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’çµ„ã¿åˆã‚ã›ãŸå¤šæ©Ÿèƒ½AIã‚¢ãƒ—ãƒªã‚’ä½“é¨“ã§ãã¾ã™ã€‚</p>
  <p>ã¾ãŸã€æœ¬ãƒ‡ãƒ¢ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã§å…¬é–‹ã—ã¦ã„ã¾ã™ï¼š<br/>
    ğŸ”— <a href="https://github.com/cuiyuze12/llm_spam_demo" target="_blank">https://github.com/cuiyuze12/llm_spam_demo</a><br/>
    ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †ã‚„ãƒ¢ãƒ‡ãƒ«å­¦ç¿’ã‚³ãƒ¼ãƒ‰ã€å„æ©Ÿèƒ½ã®å®Ÿè£…æ–¹æ³•ãªã©ã‚‚ã”ç¢ºèªã„ãŸã ã‘ã¾ã™ã€‚
  </p>
</section>

<div id="tabs">
  <div class="tab active" onclick="switchTab('llm')">è‡ªä½œLLM</div>
  <div class="tab" onclick="switchTab('rag')">è‡ªä½œRAG</div>
  <div class="tab" onclick="switchTab('agent')">è‡ªä½œAIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ</div>
    <!-- â–¼â–¼â–¼ æ–°è¦ã‚¿ãƒ–ï¼šæ³¨æ–‡æ›¸ç”Ÿæˆ â–¼â–¼â–¼ -->
  <div class="tab" onclick="switchTab('order')">ç™ºæ³¨AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ</div>
  <!-- â–²â–²â–² æ–°è¦ã‚¿ãƒ–ã“ã“ã¾ã§ â–²â–²â–² -->
</div>

<div id="llm" class="content active">
  <p>ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯ã€GPT-2 ãƒ™ãƒ¼ã‚¹ã®è‡ªä½œè»½é‡LLMã‚’æ´»ç”¨ã—ãŸ2ã¤ã®æ©Ÿèƒ½ã‚’ã”ä½“é¨“ã„ãŸã ã‘ã¾ã™ã€‚</p>
  <ul>
    <li><b>è¿·æƒ‘ãƒ¡ãƒ¼ãƒ«åˆ†é¡ï¼š</b>GPT-2 ãƒ¢ãƒ‡ãƒ«ã«å¯¾ã—ã¦ã€Œåˆ†é¡ã‚¿ã‚¹ã‚¯ã€ã®ãƒ•ã‚¡ã‚¤ãƒ³ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’æ–½ã—ã€è‹±èªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚¹ãƒ‘ãƒ ï¼éã‚¹ãƒ‘ãƒ ã«åˆ†é¡ã—ã¾ã™ã€‚</li>
    <li><b>æŒ‡ç¤ºã«åŸºã¥ãå›ç­”ç”Ÿæˆï¼š</b>åŒã˜ã GPT-2 ãƒ¢ãƒ‡ãƒ«ã«å¯¾ã—ã¦ã€Œå‘½ä»¤æ–‡å¿œç­”ã‚¿ã‚¹ã‚¯ã€ã®ãƒ•ã‚¡ã‚¤ãƒ³ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’è¡Œã„ã€è‹±èªã§ã®å¯¾è©±æŒ‡ç¤ºã«å¿œã˜ãŸå›ç­”ã‚’ç”Ÿæˆã—ã¾ã™ï¼ˆæ—¥æœ¬èªã¯æœªå¯¾å¿œï¼‰</li>
  </ul>
  <p>ã„ãšã‚Œã®ãƒ¢ãƒ‡ãƒ«ã‚‚ Google Colab ä¸Šã§å­¦ç¿’ã‚’è¡Œã„ã€ç¾åœ¨ã¯ EC2 ä¸Šã® Web ã‚¢ãƒ—ãƒªã‹ã‚‰ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§æ¨è«–å¯èƒ½ã§ã™ã€‚<br>
    ãªãŠã€æœ¬ãƒ‡ãƒ¢ã§ã¯è¨ˆç®—ãƒªã‚½ãƒ¼ã‚¹ã®åˆ¶ç´„ã‚’è€ƒæ…®ã—ã€è»½é‡ãª GPT-2 ãƒ¢ãƒ‡ãƒ«ã‚’æ¡ç”¨ã—ã¦ã„ã‚‹ãŸã‚ã€<strong>å¯¾å¿œè¨€èªã¯è‹±èªã®ã¿ã«é™å®šã—ã¦ã„ã¾ã™</strong>ã€‚
  </p>
  <h3>1. ã‚¹ãƒ‘ãƒ åˆ†é¡ãƒ¢ãƒ‡ãƒ«å­¦ç¿’</h3>
  <p>ã“ã®åˆ†é¡ãƒ¢ãƒ‡ãƒ«ã¯ Google Colab ä¸Šã§äº‹å‰ã«è¨“ç·´ã•ã‚Œã¾ã—ãŸã€‚å­¦ç¿’ã®è©³ç´°ã¯ã“ã¡ã‚‰ï¼š</p>
  <a href="https://colab.research.google.com/drive/1hdvDvt_2Bdi6xo7g8RCQMG2IDc88mCGH?usp=sharing" target="_blank">
    â–¶ Google Colab Notebook ã‚’è¦‹ã‚‹
  </a>
  <h3>2. ã‚¹ãƒ‘ãƒ åˆ†é¡ã‚’è©¦ã—ã¦ã¿ã‚ˆã†</h3>
  <details style="margin-bottom: 15px;">
    <summary><b>ğŸ“Œ åˆ†é¡ã®ä¾‹ã‚’è¡¨ç¤ºï¼ˆã‚¯ãƒªãƒƒã‚¯ã§å±•é–‹ï¼‰</b></summary>
    <div style="margin-top: 10px;">
      <b>ğŸŸ¢ éã‚¹ãƒ‘ãƒ ä¾‹:</b>
      <ul>
        <li>Letâ€™s meet at 3 PM for the project discussion.</li>
        <li>Your Amazon package has been shipped.</li>
        <li>Can you send me the updated file?</li>
      </ul>
      <b>ğŸ”´ ã‚¹ãƒ‘ãƒ ä¾‹:</b>
      <ul>
        <li>This is a limited time offer! Click now to win a free iPhone!</li>
        <li>You are a winner you have been specially  selected to receive $1000 cash or a $2000 award.</li>
        <li>Call Free 0800 1956669 or text back help</li>
      </ul>
    </div>
  </details>

  <input type="text" id="spam_input" placeholder="ã“ã“ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è‹±èªã§å…¥åŠ›ã—ã¦ãã ã•ã„">
  <br>
  <button onclick="checkSpam()">åˆ†é¡</button>
  <div id="spam_output" class="output"></div>

  <hr/>
  <h3>3. æŒ‡ç¤ºã«åŸºã¥ãå›ç­”ç”Ÿæˆãƒ¢ãƒ‡ãƒ«å­¦ç¿’</h3>
  <p>ã“ã®åˆ†é¡ãƒ¢ãƒ‡ãƒ«ã¯ Google Colab ä¸Šã§äº‹å‰ã«è¨“ç·´ã•ã‚Œã¾ã—ãŸã€‚å­¦ç¿’ã®è©³ç´°ã¯ã“ã¡ã‚‰ï¼š</p>
  <a href="https://colab.research.google.com/drive/1AuHT-n5hmgOjXYdXSzgLO6-3D46lEEu9?usp=sharing" target="_blank">
    â–¶ Google Colab Notebook ã‚’è¦‹ã‚‹
  </a>
  <h3>4. æŒ‡ç¤ºã«åŸºã¥ãå›ç­”ç”Ÿæˆã‚’è©¦ã—ã¦ã¿ã‚ˆã†</h3>
  <details>
    <summary><b>ğŸ“Œ æŒ‡ç¤ºå…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã¨ä¾‹ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§å±•é–‹ï¼‰</b></summary>
    <p>ä»¥ä¸‹ã®å½¢å¼ã§è‹±èªã®æŒ‡ç¤ºã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š</p>
    <pre style="background-color: #f4f4f4; padding: 10px; border-radius: 5px;">
Below is an instruction that describes a task. Write a response that appropriately completes the request.

### Instruction:
Rewrite the sentence using a simile.

### Input:
The car is very fast.</pre>
    <p>ãã®ä»–ã®ä¾‹ï¼š</p>
    <ul>
      <li><code>### Instruction:</code> What type of cloud is typically associated with thunderstorms? </li>
      <li><code>### Instruction:</code> Rewrite the following sentence using passive voice. <br><code>### Input:</code> The team achieved great results.</li>
    </ul>
  </details>
  <textarea id="generate_input" placeholder="ã“ã“ã«æŒ‡ç¤ºã‚’è‹±èªã§å…¥åŠ›ã—ã¦ãã ã•ã„" rows="8" style="width: 80%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 4px;"></textarea>
  <br>
  <button onclick="generateResponse()">é€ä¿¡</button>
  <div id="generate_output" class="output"></div>
</div>

<div id="rag" class="content">
  <h3>RAG è³ªå•å¿œç­”</h3>
  <p>
    ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯ã€è‡ªä½œã®RAGï¼ˆRetrieval-Augmented Generationï¼‰æ©Ÿèƒ½ã‚’ã”ä½“é¨“é ‚ã‘ã¾ã™ã€‚<br/>
    Amazon Bedrockã®Knowledge Baseæ©Ÿèƒ½ã‚’æ´»ç”¨ã—ã€ç¤¾å†…è³‡æ–™ã‚’æ¤œç´¢ãƒ»è¦ç´„ã—ã¦æ—¥æœ¬èªã§ã®å›ç­”ã‚’ç”Ÿæˆã—ã¾ã™ã€‚
  </p>
  <p>
    ç¾åœ¨ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ãƒŠãƒ¬ãƒƒã‚¸ãƒ™ãƒ¼ã‚¹ã«ã¯ã€æ ªå¼ä¼šç¤¾æ—¥æœ¬å–å¼•æ‰€ã‚°ãƒ«ãƒ¼ãƒ—ï¼ˆJPXï¼‰ã®2023å¹´åº¦ç¬¬2å››åŠæœŸãƒ»ç¬¬3å››åŠæœŸã®æ±ºç®—èª¬æ˜è³‡æ–™ï¼ˆPDFï¼‰ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚
    ã“ã‚Œã‚‰ã®è³‡æ–™ã«ã¯ã€å£²ä¸Šãƒ»å–¶æ¥­åˆ©ç›Šã®å¤‰å‹•è¦å› ã€å–å¼•æ‰€åˆ¥ã®æ¥­ç¸¾ã€æŠ•è³‡å®¶å‘ã‘ã®æ–½ç­–ã€è²»ç”¨æ§‹é€ ã®åˆ†æãªã©ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚
  </p>
  <details>
    <summary><b>ğŸ“Œ è³ªå•ä¾‹ã‚’è¡¨ç¤ºï¼ˆã‚¯ãƒªãƒƒã‚¯ã§å±•é–‹ï¼‰</b></summary>
    <ul>
      <li>2023å¹´åº¦ç¬¬3å››åŠæœŸã®å£²ä¸ŠãŒå¢—ãˆãŸç†ç”±ã¯ä½•ã§ã™ã‹ï¼Ÿ</li>
      <li>JPXã®2023å¹´3Qã®æ±ºç®—ã«ã¤ã„ã¦æ•™ãˆã¦ãã ã•ã„ã€‚</li>
      <li>2023å¹´ç¬¬2å››åŠæœŸã¨ç¬¬3å››åŠæœŸã®æ¯”è¼ƒã§ã€è²»ç”¨ã®å¢—æ¸›è¦å› ã¯ä½•ã§ã™ã‹ï¼Ÿ</li>
      <li>JPXã¯ä¸­æœŸçš„ã«ã©ã®ã‚ˆã†ãªITæŠ•è³‡ã‚’è¨ˆç”»ã—ã¦ã„ã¾ã™ã‹ï¼Ÿ</li>
    </ul>
  </details>
  <input type="text" id="rag_input" placeholder="è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„">
  <button onclick="sendRAG()">æ¤œç´¢</button>
  <div id="rag_output" class="output"></div>
</div>

<div id="agent" class="content">
  <p>
    ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯ã€Bedrock Agent ã«ã‚ˆã‚‹ AI ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¨ã®ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ã‚’ã”ä½“é¨“ã„ãŸã ã‘ã¾ã™ã€‚<br/>
    æœ¬ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ã€ReActï¼ˆReasoning + Actingï¼‰æ‰‹æ³•ã«åŸºã¥ãã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æŒ‡ç¤ºå†…å®¹ã‚’ç†è§£ãƒ»åˆ†é¡ã—ãŸä¸Šã§ã€é©åˆ‡ãªæƒ…å ±æºã‚’é¸å®šã—ã€è‡ªå‹•ã§ã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œãƒ»å¿œç­”ã™ã‚‹æ§‹æˆã¨ãªã£ã¦ã„ã¾ã™ã€‚
  </p>

  <ul>
    <li>ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•å†…å®¹ã‚’ä»¥ä¸‹ã® 3 ã‚«ãƒ†ã‚´ãƒªã«åˆ†é¡ã—ã€ãã‚Œãã‚Œé©åˆ‡ãªæ–¹æ³•ã§å›ç­”ã‚’ç”Ÿæˆã—ã¾ã™ï¼š</li>
    <ul>
      <li>
        <b>a) AWSã®æœ€æ–°æƒ…å ±ã«é–¢ã™ã‚‹è³ªå•ï¼š</b><br/>
        â†’ Lambda é–¢æ•°ã‚’å‘¼ã³å‡ºã—ã¦ã€<a href="https://aws.amazon.com/jp/blogs/aws/" target="_blank">AWSå…¬å¼ãƒ–ãƒ­ã‚°</a> ã®æœ€æ–°æƒ…å ±ã‚’å–å¾—ã—ã€è¦ç´„ã—ã¦å›ç­”ã—ã¾ã™ã€‚
      </li>
      <li>
        <b>b) æ—¥æœ¬å–å¼•æ‰€ã‚°ãƒ«ãƒ¼ãƒ—ï¼ˆJPXï¼‰ã®æ±ºç®—ã«é–¢ã™ã‚‹è³ªå•ï¼š</b><br/>
        â†’ RAG æ©Ÿèƒ½ï¼ˆç¤¾å†…ãƒŠãƒ¬ãƒƒã‚¸ãƒ™ãƒ¼ã‚¹ï¼‰ã‚’ä½¿ç”¨ã—ã¦é–¢é€£è³‡æ–™ã‹ã‚‰æ¤œç´¢ãƒ»å›ç­”ã—ã¾ã™ã€‚
      </li>
      <li>
        <b>c) ãã‚Œä»¥å¤–ã®ä¸€èˆ¬çš„ãªè³ªå•ï¼š</b><br/>
        â†’ Claude 3 ãƒ¢ãƒ‡ãƒ«ãŒæŒã¤çŸ¥è­˜ã‚’ã‚‚ã¨ã«ç›´æ¥å›ç­”ã—ã¾ã™ã€‚
      </li>
    </ul>

    <li>
      <details>
        <summary><b>ğŸ“Œ è³ªå•ä¾‹ã‚’è¡¨ç¤ºï¼ˆã‚¯ãƒªãƒƒã‚¯ã§å±•é–‹ï¼‰</b></summary>
        <ul>
          <li><b>a)</b> AWSã®æœ€æ–°æƒ…å ±ã«ã¤ã„ã¦æ•™ãˆã¦ãã ã•ã„ã€‚</li>
          <li><b>b)</b> JPXã®ç¬¬3å››åŠæœŸã®å£²ä¸ŠãŒå¢—ãˆãŸç†ç”±ã¯ï¼Ÿ</li>
          <li><b>c)</b> ä¸–ç•Œã§ä¸€ç•ªæ­´å²ãŒé•·ã„å›½ã‚’æ•™ãˆã¦ãã ã•ã„ã€‚</li>
        </ul>
      </details>
    </li>
  </ul>

  <h3>AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ ãƒãƒ£ãƒƒãƒˆ</h3>
  <input type="text" id="agent_input" placeholder="æŒ‡ç¤ºã‚’å…¥åŠ›ã—ã¦ãã ã•ã„">
  <button onclick="sendAgent()">å®Ÿè¡Œ</button>
  <div id="agent_output" class="output"></div>
</div>

<!-- â–¼â–¼â–¼ æ–°è¦ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ï¼šæ³¨æ–‡æ›¸ç”Ÿæˆï¼ˆJSONè¡¨ç¤ºï¼‰ â–¼â–¼â–¼ -->
<div id="order" class="content">
  <h3>æ³¨æ–‡æ›¸ç”Ÿæˆï¼ˆè‡ªç„¶è¨€èªâ†’æ§‹é€ åŒ–JSONâ†’æ³¨æ–‡æƒ…å ±ï¼‰</h3>
  <p class="muted">ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ—¥æœ¬èªä¾é ¼ã‚’ LLM ãŒè§£æã—ã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§ Pydantic ã«ã‚ˆã‚Šå³å¯†æ¤œè¨¼ã—ãŸ JSON ã‚’è¿”ã—ã¾ã™ã€‚</p>

  <details>
    <summary><b>ğŸ“Œ å…¥åŠ›ä¾‹ã‚’è¡¨ç¤ºï¼ˆã‚¯ãƒªãƒƒã‚¯ã§å±•é–‹ï¼‰</b></summary>
    <div style="margin-top: 8px;">
      ä¾‹ï¼š<br>
      æ³¨æ–‡æ›¸ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚ç™ºæ³¨è€…åã¯å±±æœ¬è£•å­ã€<br>
       MyPhone-5Gï¼ˆSKU: MY001ï¼‰ã‚’3å°ï¼ˆå˜ä¾¡39,800å††ï¼‰
    </div>
  </details>

  <textarea id="order_chat_first" rows="3" placeholder="ä¾‹ï¼šã‚¹ãƒãƒ›ã‚’2å°æ³¨æ–‡ã—ã¾ã™ã€‚ç™ºæ³¨è€…åã¯â€¦"></textarea>
  <br>
  <button onclick="startOrderChat()">å¯¾è©±ã‚’é–‹å§‹</button>
  <div id="order_chat_log" class="output" style="min-height:120px;"></div>
  <div id="order_missing_input_area" style="margin-top:8px; display:none;">
    <input type="text" id="order_chat_answer" placeholder="ã“ã“ã«å›ç­”ã‚’å…¥åŠ›ï¼ˆä¾‹ï¼šABCå•†äº‹ï¼‰">
    <button class="btn-secondary" onclick="replyOrderChat()">é€ä¿¡</button>
  </div>
  <pre id="order_chat_result" class="output" style="display:none;"></pre>
  <div id="pdf_download_area" style="margin-top:20px; display:none;">
    <button id="btn-download" onclick="downloadOrder()" class="btn">æ³¨æ–‡æ›¸ï¼ˆPDFï¼‰ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
    <button id="btn-reset" onclick="resetPage()" class="btn-secondary">ãƒªã‚»ãƒƒãƒˆ</button>
  <div id="dl-status" style="display:none; margin-top:8px;">
  <span id="dl-text">ç”Ÿæˆä¸­...</span>
  <progress id="dl-progress" value="0" max="1" style="width:240px; vertical-align:middle;"></progress>
</div>
</div>
<!-- â–²â–²â–² æ–°è¦ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã“ã“ã¾ã§ â–²â–²â–² -->

<script>
  // ===== è¨­å®š =====

  function switchTab(tabName) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
    document.querySelector(`.tab[onclick*="${tabName}"]`).classList.add('active');
    document.getElementById(tabName).classList.add('active');
  }

  async function checkSpam() {
    const text = document.getElementById('spam_input').value;
    const spamResultArea = document.getElementById('spam_output');
    spamResultArea.textContent = "åˆ†é¡ä¸­...";

    try {
      const response = await fetch('/api/predict', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text })
      });

      if (!response.ok) {
        spamResultArea.textContent = "Error: " + response.statusText;
        return;
      }

      const data = await response.json();
      spamResultArea.innerHTML = `<b>åˆ†é¡:</b> ${data.label} <br><b>ä¿¡é ¼åº¦:</b> ${data.confidence.toFixed(4)}`;
    } catch (err) {
      spamResultArea.textContent = "Request failed: " + err.message;
    }
  }

  async function generateResponse() {
    const prompt = document.getElementById('generate_input').value;
    const resultArea = document.getElementById('generate_output');
    resultArea.textContent = "ç”Ÿæˆä¸­(æ•°ç§’ã‹ã‹ã‚Šã¾ã™ã®ã§å°‘ã€…ãŠå¾…ã¡ãã ã•ã„)...";

    try {
      const response = await fetch('/api/generate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ prompt })
      });

      if (!response.ok) {
        resultArea.textContent = "Error: " + response.statusText;
        return;
      }

      const data = await response.json();
      resultArea.innerHTML = `<b>ç”Ÿæˆçµæœ:</b><br/>${data.response}`;
    } catch (err) {
      resultArea.textContent = "Request failed: " + err.message;
    }
  }

  async function sendRAG() {
    const resultArea = document.getElementById('rag_output');
    resultArea.textContent = "ç”Ÿæˆä¸­(æ•°ç§’ã‹ã‹ã‚Šã¾ã™ã®ã§å°‘ã€…ãŠå¾…ã¡ãã ã•ã„)...";
    const input = document.getElementById("rag_input").value;
    const res = await fetch("/api/rag_qa", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({query: input})
    });
    const data = await res.json();
    document.getElementById("rag_output").innerText = data.answer || "å¿œç­”ãŒã‚ã‚Šã¾ã›ã‚“";
  }

  async function sendAgent() {
    const resultArea = document.getElementById('agent_output');
    resultArea.textContent = "ç”Ÿæˆä¸­(æ•°ç§’ã‹ã‹ã‚Šã¾ã™ã®ã§å°‘ã€…ãŠå¾…ã¡ãã ã•ã„)...";
    const input = document.getElementById("agent_input").value;
    const res = await fetch("/api/agent_chat", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({message: input})
    });
    const data = await res.json();
    document.getElementById("agent_output").innerText = data.answer || "å¿œç­”ãŒã‚ã‚Šã¾ã›ã‚“";
  }
  
  // ===== æ³¨æ–‡æ›¸ç”Ÿæˆï¼ˆJSONè¡¨ç¤ºï¼‰ =====
  let orderDraft = null;
  let currentField = null;

  async function startOrderChat() {
    const text = document.getElementById('order_chat_first').value.trim();
    const log = document.getElementById('order_chat_log');
    const result = document.getElementById('order_chat_result');
    result.style.display = 'none';
    result.textContent = '';

    if (!text) { log.textContent = 'å…¥åŠ›ãŒç©ºã§ã™ã€‚'; return; }
    log.textContent = 'è§£æä¸­...';

    const res = await fetch('/agent/order/start', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ text, template_id: 'invoice_default_v1' })
    });
    const data = await res.json();

    if (data.status === 'ask') {
      orderDraft = data.draft;
      currentField = data.field;
      log.textContent = `è³ªå•ï¼š${data.question}`;

      document.getElementById('order_missing_input_area').style.display = 'block';
      document.getElementById('pdf_download_area').style.display = 'none';
      document.getElementById('order_chat_answer').value = '';

    } else if (data.status === 'done') {
      log.textContent = 'ã™ã¹ã¦ã®å¿…é ˆé …ç›®ãŒæƒã„ã¾ã—ãŸã€‚ä»¥ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€æ³¨æ–‡æ›¸PDFã‚’ç”Ÿæˆãƒ»ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚';
      result.textContent = JSON.stringify(data.order, null, 2);

      document.getElementById('order_missing_input_area').style.display = 'none';
      document.getElementById('pdf_download_area').style.display = 'block';

    } else {
      log.textContent = 'ã‚¨ãƒ©ãƒ¼ï¼š' + JSON.stringify(data);
    }
  }

  async function replyOrderChat() {
    const ans = document.getElementById('order_chat_answer').value.trim();
    const log = document.getElementById('order_chat_log');
    const result = document.getElementById('order_chat_result');
    if (!orderDraft || !currentField) { log.textContent = 'å…ˆã«å¯¾è©±ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚'; return; }
    if (!ans) { return; }

    log.textContent = 'æ›´æ–°ä¸­...';

    const res = await fetch('/agent/order/reply', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ draft: orderDraft, field: currentField, answer: ans })
    });
    const data = await res.json();

    if (data.status === 'ask') {
      orderDraft = data.draft;
      currentField = data.field;
      log.textContent = `è³ªå•ï¼š${data.question}`;
      document.getElementById('order_chat_answer').value = '';

    } else if (data.status === 'done') {
      log.textContent = 'ã™ã¹ã¦ã®å¿…é ˆé …ç›®ãŒæƒã„ã¾ã—ãŸã€‚ä»¥ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€æ³¨æ–‡æ›¸PDFã‚’ç”Ÿæˆãƒ»ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚';
      result.textContent = JSON.stringify(data.order, null, 2);
      
      document.getElementById('order_chat_answer').value = '';
      document.getElementById('order_missing_input_area').style.display = 'none';
      document.getElementById('pdf_download_area').style.display = 'block';
    } else {
      log.textContent = 'ã‚¨ãƒ©ãƒ¼ï¼š' + JSON.stringify(data);
    }
  }
  
  async function downloadOrder() {
    const btn = document.getElementById('btn-download');
    const panel = document.getElementById('dl-status');
    const text = document.getElementById('dl-text');
    const bar  = document.getElementById('dl-progress');

    const ctrl = new AbortController();
    const timeoutMs = 120000; // å¯é€‰ï¼šè¶…æ—¶å–æ¶ˆï¼ˆ120ç§’ï¼‰
    const timeoutId = setTimeout(() => ctrl.abort(), timeoutMs);

    // UI: è¿›å…¥loading
    setLoading(true);

    const rawText = document.getElementById('order_chat_result').textContent;

    let payload;
    try {
      payload = JSON.parse(rawText);   // è½¬æˆå¯¹è±¡
    } catch (e) {
      console.error("ä¸æ˜¯åˆæ³•çš„ JSON:", e);
      alert("è®¢å•æ•°æ®ä¸æ˜¯åˆæ³• JSON");
      return;
    }

    try {
      const resp = await fetch('/orders/pdf', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
        signal: ctrl.signal
      });

      if (!resp.ok) {
        // å°è¯•è¯»å–é”™è¯¯è¯¦æƒ…
        let msg = `${resp.status} ${resp.statusText}`;
        try {
          const err = await resp.json();
          if (err?.detail) msg += `\n${(typeof err.detail === 'string') ? err.detail : JSON.stringify(err.detail)}`;
        } catch (_) {}
        throw new Error(msg);
      }

      // ä»å“åº”å¤´å–æ–‡ä»¶åï¼ˆContent-Dispositionï¼‰
      const cd = resp.headers.get('Content-Disposition') || '';
      let filename = 'order.pdf';
      const m = cd.match(/filename\*?=(?:UTF-8'')?([^;]+)/i);
      if (m) filename = decodeURIComponent(m[1].replace(/"/g, ''));

      // å¦‚æœæ”¯æŒæµ & æœ‰ Content-Length å°±æ˜¾ç¤ºè¿›åº¦
      const total = Number(resp.headers.get('Content-Length')) || 0;

      let blob;
      if (resp.body && 'getReader' in resp.body && total > 0) {
        const reader = resp.body.getReader();
        const chunks = [];
        let received = 0;
        text.textContent = 'ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­...';
        bar.removeAttribute('hidden');
        bar.max = 1;
        bar.value = 0;

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          chunks.push(value);
          received += value.length;
          bar.value = received / total; // æ›´æ–°è¿›åº¦æ¡
        }
        blob = new Blob(chunks, { type: 'application/pdf' });
      } else {
        // é€€åŒ–å¤„ç†ï¼šæ— æ³•æµ‹é‡è¿›åº¦ï¼ˆä¾‹å¦‚æ— Content-Lengthï¼‰
        text.textContent = 'ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­...';
        bar.setAttribute('hidden', 'hidden');
        blob = await resp.blob();
      }

      // è§¦å‘ä¿å­˜
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);

      // å¯é€‰ï¼šæˆåŠŸæç¤º
      text.textContent = 'å®Œäº†';
      setTimeout(() => setLoading(false), 600); // ç¨åœä¸€ä¸‹å†æ¢å¤
    } catch (err) {
      console.error(err);
      text.textContent = 'å¤±æ•—ã—ã¾ã—ãŸ';
      alert('PDFã®ç”Ÿæˆ/ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n' + (err?.message || err));
      setLoading(false);
    } finally {
      clearTimeout(timeoutId);
    }

    function setLoading(loading) {
      if (loading) {
        btn.disabled = true;
        btn.setAttribute('aria-busy', 'true');
        panel.style.display = 'block';
        text.textContent = 'ç”Ÿæˆä¸­...';
        bar.removeAttribute('hidden');
        bar.value = 0;
      } else {
        btn.disabled = false;
        btn.removeAttribute('aria-busy');
        panel.style.display = 'none';
        text.textContent = '';
        bar.value = 0;
      }
    }
  }

  function resetPage() {
    document.getElementById('order_chat_first').value = '';
    document.getElementById('order_chat_log').textContent = '';
    document.getElementById('order_chat_result').textContent = '';
    document.getElementById('order_chat_result').style.display = 'none';
    document.getElementById('order_missing_input_area').style.display = 'none';
    document.getElementById('pdf_download_area').style.display = 'none';
    orderDraft = null;
    currentField = null;
  }

</script>
</body>
</html>