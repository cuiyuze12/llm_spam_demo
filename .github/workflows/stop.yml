name: Stop wonderlusia on EC2

on:
  workflow_dispatch: {}

jobs:
  stop-server:
    runs-on: ubuntu-latest

    steps:
      - name: Stop wonderlusia via SSH (systemd first, legacy fallback)
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            set -Eeuo pipefail

            SERVICE_NAME="wonderlusia"
            # å°è¯•å¸¸è§è·¯å¾„ï¼›è‹¥ä¸Žä½ ä¸åŒï¼Œå¯æ”¹æˆä½ çš„ç»å¯¹è·¯å¾„
            if [ -d "/home/ubuntu/llm_spam_demo" ]; then
              PROJECT_DIR="/home/ubuntu/llm_spam_demo"
            else
              PROJECT_DIR="$HOME/llm_spam_demo"
            fi
            PIDFILE="$PROJECT_DIR/uvicorn.pid"
            PORT="5000"

            echo "ðŸ”Ž Target project dir: $PROJECT_DIR"
            echo "ðŸ›‘ Stopping ${SERVICE_NAME}â€¦"

            # é€‰ç”¨ sudoï¼ˆè‹¥ NOPASSWD æœªé…ç½®ï¼Œå»ºè®®ç»™ ubuntu é… NOPASSWDï¼‰
            if command -v sudo >/dev/null 2>&1; then
              SUDO="sudo -n"
            else
              SUDO=""
            fi

            # 1) ä¼˜å…ˆå°è¯• systemd
            if command -v systemctl >/dev/null 2>&1 && systemctl list-unit-files | grep -q "^${SERVICE_NAME}.service"; then
              echo "â–¶ Using systemd: systemctl stop ${SERVICE_NAME}.service"
              $SUDO systemctl stop "${SERVICE_NAME}.service" || true
              # ç»™ä¸€äº›æ—¶é—´è®©ç«¯å£é‡Šæ”¾
              sleep 2
              echo "â„¹ï¸ systemd active status (expect inactive):"
              $SUDO systemctl is-active "${SERVICE_NAME}.service" || true
            else
              echo "âš ï¸ No systemd unit '${SERVICE_NAME}.service' found. Falling back to legacy methods."
            fi

            # 2) æ—§æ–¹å¼ï¼šPID æ–‡ä»¶
            if [ -f "$PIDFILE" ]; then
              PID=$(cat "$PIDFILE" || true)
              if [ -n "${PID:-}" ] && kill -0 "$PID" >/dev/null 2>&1; then
                echo "â–¶ Killing uvicorn by PID file: $PID"
                $SUDO kill "$PID" || true
                sleep 2
                if kill -0 "$PID" >/dev/null 2>&1; then
                  echo "âš ï¸ Force killing PID: $PID"
                  $SUDO kill -9 "$PID" || true
                fi
                echo "âœ… uvicorn (PID file) stopped."
              else
                echo "â„¹ï¸ PID file present but process not running."
              fi
              rm -f "$PIDFILE" || true
            else
              echo "â„¹ï¸ No PID file at $PIDFILE"
            fi

            # 3) å…œåº•ï¼šæŒ‰è¿›ç¨‹ç‰¹å¾æ€ï¼ˆæžç«¯åœºæ™¯ï¼‰
            echo "â–¶ Final fallback: pkill uvicorn pattern"
            $SUDO pkill -f 'uvicorn .*api_server:app' || true

            # 4) æ”¶å°¾æ£€æŸ¥
            echo "ðŸ”Ž Post-stop checks:"
            $SUDO ss -lptn "sport = :$PORT" || true
            pgrep -af uvicorn || true
            if command -v journalctl >/dev/null 2>&1; then
              echo "ðŸ§¾ Recent logs (last 40 lines):"
              $SUDO journalctl -u "${SERVICE_NAME}" -n 40 --no-pager || true
            fi

            echo "âœ… Done."

            exit 0