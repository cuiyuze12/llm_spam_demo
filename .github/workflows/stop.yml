name: Stop wonderlusia on EC2

on:
  workflow_dispatch: {}

jobs:
  stop-server:
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: Stop wonderlusia via SSH (systemd first, legacy fallback)
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            # ä¸å› ä¸ºå•æ¡å‘½ä»¤å¤±è´¥è€Œä¸­æ–­ï¼›æˆ‘ä»¬æ‰‹åŠ¨æ§åˆ¶è¿”å›ç 
            set +e

            SERVICE_NAME="wonderlusia"
            # å¦‚ä¸ä½ ä¸åŒï¼Œè¯·æ”¹æˆç»å¯¹è·¯å¾„
            PROJECT_DIR="/home/ubuntu/llm_spam_demo"
            [ -d "$PROJECT_DIR" ] || PROJECT_DIR="$HOME/llm_spam_demo"
            PIDFILE="$PROJECT_DIR/uvicorn.pid"
            PORT="5000"

            if command -v sudo >/dev/null 2>&1; then SUDO="sudo -n"; else SUDO=""; fi

            echo "ğŸ” Target: $PROJECT_DIR"
            echo "ğŸ›‘ Stopping $SERVICE_NAME ..."

            # 1) ä¼˜å…ˆ systemd
            if command -v systemctl >/dev/null 2>&1; then
              $SUDO systemctl stop "${SERVICE_NAME}.service" >/dev/null 2>&1 || true
              sleep 1
              echo "â„¹ï¸ systemd state:" && $SUDO systemctl is-active "${SERVICE_NAME}.service" 2>/dev/null || true
            fi

            # 2) æ—§ PID æ–‡ä»¶
            if [ -f "$PIDFILE" ]; then
              PID="$(cat "$PIDFILE" 2>/dev/null || true)"
              if [ -n "$PID" ]; then
                echo "â–¶ Killing PID: $PID"
                $SUDO kill "$PID" 2>/dev/null || true
                sleep 1
                $SUDO kill -9 "$PID" 2>/dev/null || true
              fi
              rm -f "$PIDFILE" 2>/dev/null || true
            fi

            # 3) å…œåº•
            $SUDO pkill -f 'uvicorn .*api_server:app' 2>/dev/null || true

            echo "ğŸ” Post-stop checks (non-fatal):"
            $SUDO ss -lptn "sport = :$PORT" || true
            pgrep -af uvicorn || true
            command -v journalctl >/dev/null 2>&1 && $SUDO journalctl -u "${SERVICE_NAME}" -n 20 --no-pager || true

            echo "âœ… Stop workflow finished."
            # æ— è®ºä¸Šé¢æœ‰æ— é 0ï¼Œéƒ½è®©æ•´æ­¥æˆåŠŸ
            exit 0