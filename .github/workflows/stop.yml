name: Stop wonderlusia on EC2

on:
  workflow_dispatch: {}

jobs:
  stop-server:
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: Stop wonderlusia via SSH (systemd first, legacy fallback)
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            # 不因为单条命令失败而中断；我们手动控制返回码
            set +e

            SERVICE_NAME="wonderlusia"
            # 如与你不同，请改成绝对路径
            PROJECT_DIR="/home/ubuntu/llm_spam_demo"
            [ -d "$PROJECT_DIR" ] || PROJECT_DIR="$HOME/llm_spam_demo"
            PIDFILE="$PROJECT_DIR/uvicorn.pid"
            PORT="5000"

            if command -v sudo >/dev/null 2>&1; then SUDO="sudo -n"; else SUDO=""; fi

            echo "🔎 Target: $PROJECT_DIR"
            echo "🛑 Stopping $SERVICE_NAME ..."

            # 1) 优先 systemd
            if command -v systemctl >/dev/null 2>&1; then
              $SUDO systemctl stop "${SERVICE_NAME}.service" >/dev/null 2>&1 || true
              sleep 1
              echo "ℹ️ systemd state:" && $SUDO systemctl is-active "${SERVICE_NAME}.service" 2>/dev/null || true
            fi

            # 2) 旧 PID 文件
            if [ -f "$PIDFILE" ]; then
              PID="$(cat "$PIDFILE" 2>/dev/null || true)"
              if [ -n "$PID" ]; then
                echo "▶ Killing PID: $PID"
                $SUDO kill "$PID" 2>/dev/null || true
                sleep 1
                $SUDO kill -9 "$PID" 2>/dev/null || true
              fi
              rm -f "$PIDFILE" 2>/dev/null || true
            fi

            # 3) 兜底
            $SUDO pkill -f 'uvicorn .*api_server:app' 2>/dev/null || true

            echo "🔎 Post-stop checks (non-fatal):"
            $SUDO ss -lptn "sport = :$PORT" || true
            pgrep -af uvicorn || true
            command -v journalctl >/dev/null 2>&1 && $SUDO journalctl -u "${SERVICE_NAME}" -n 20 --no-pager || true

            echo "✅ Stop workflow finished."
            # 无论上面有无非 0，都让整步成功
            exit 0